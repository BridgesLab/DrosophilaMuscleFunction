{
    "contents" : "\\documentclass{article}\n\n\\usepackage{fullpage}\n\\usepackage[colorlinks=true]{hyperref}\n\\usepackage[tableposition=top]{caption}\n\\usepackage[utf8]{inputenc}\n\n\\begin{document}\n\\SweaveOpts{concordance=FALSE}\n\n\\title{Analysis of Longevity from Muscle TSC1/Raptor Flies}\n\\author{Isabelle Hatfield and Dave Bridges}\n\\date{\\today}\n\\maketitle\n\n\n\\section*{Experimental Design}\n\n<<data-input, echo=FALSE>>=\nrequire(RCurl, quietly=T)\nrequire(lubridate, quietly=T)\nbirth_worksheet <- 'https://docs.google.com/spreadsheet/pub?key=0Aitfmor6rCjYdHpHTk1BZVh0MFEtNDV6QVI2V2RWSEE&single=true&gid=0&output=csv' \ndeath_worksheet <- 'https://docs.google.com/spreadsheet/pub?key=0Am2qM2oZ12_jdHd3RTdVUjNuQWxtYmV1S2laR3M4Znc&single=true&gid=0&output=csv'\n\nmapping_data <- read.csv('Data/gene_mapping.csv')\nbirth_file <- getURL(birth_worksheet)\ndeath_file <- getURL(death_worksheet)\nbirth_data <- read.csv(textConnection(birth_file))\ndeath_data <- read.csv(textConnection(death_file))\ndata <- merge(death_data, birth_data[duplicated(birth_data$CrossName)==FALSE,c('CrossName','Generation','Cross','Replicate','DateStarted', 'Male', 'Female')], by='CrossName')\ndata$Birth.Date <- mdy(gsub(\"/\", \"-\", data$Birth.Date))\ndata$Death.Date <- mdy(gsub(\"/\", \"-\", data$Death.Date))\ndata$Age <- as.integer(data$Death.Date - data$Birth.Date)\ndata$Cross <- as.factor(paste(data$Male, data$Female, sep=\" x \"))\ndata$Driver <- as.factor(sapply(strsplit(as.character(data$Female), \"/\"),\"[\", 1))\ndata$UAS <- factor(sapply(strsplit(as.character(data$Male), \"/\"),\"[\", 1), levels=c('31039','31314','35144','31528','31529','34814'))\n\ndata <- merge(data, mapping_data)\n#moved gender to being case insensitive\ndata$Gender <- as.factor(tolower(data$Gender))\n#made genotype case insensitive\ndata$Phenotype <- as.factor(tolower(data$Phenotype))\ndata$Genotype[data$Phenotype =='wt'] <- \"shRNA/GAL4\"\ndata$Genotype[data$Phenotype == 'ser'] <- \"shRNA/+\"\ndata$Genotype[data$Phenotype == 'tm6b'] <- \"GAL4/+\"\ndata$Genotype[data$Phenotype == 'tm6b/ser'] <- \"+/+\"\ndata$Genotype[data$Phenotype == 'tm6b/sb'] <- \"+/+\"\n#made genotype into a factor\ndata$Genotype <- as.factor(data$Genotype)\n#set levels of genotype\ndata$Genotype <- factor(data$Genotype, levels=c(\"shRNA/GAL4\",\"shRNA/+\",\"GAL4/+\",\"+/+\"))\ndata$Genotype <- relevel(data$Genotype, ref=\"shRNA/GAL4\")\n\ndata <- droplevels(data)\nwrite.csv(data, \"Data/Longevity Analysis Data.csv\")\n@\n\nThese data are stored in the \\textbf{Data} subfolder.  This script was most recently run on \\Sexpr{date()}.  There has been a total of \\textbf{\\Sexpr{dim(death_data)[1]}} deaths, with \\textbf{\\Sexpr{dim(death_data[death_data$Accidental==FALSE,])[1]}} of natural causes and \\textbf{\\Sexpr{dim(death_data[death_data$Phenotype!='?'&death_data$Accidental==FALSE,])[1]}} of identifiable genotypes excluding accidental deaths.  The oldest fly recorded so far was \\textbf{\\Sexpr{ max(data$Age, na.rm=T)}} days old at time of death.\n\n<<label=histogram, include=FALSE, echo=FALSE>>=\nwith(data[data$Accidental==FALSE&data$Gender=='female',], plot(density(Age, na.rm=T), main=\"Natural Death Distribution\", sub=\"All Flies Combined\", col=\"red\"))\nwith(data[data$Accidental==FALSE&data$Gender=='male',], lines(density(Age, na.rm=T), col=\"black\"))\nlegend(\"topright\", c(\"Male\",\"Female\"), lty=1, col=c(\"black\",\"red\"), bty=\"n\")\n@\n\n\\begin{figure}\n\\begin{center}\n<<label=histogram,fig=TRUE,echo=FALSE>>=\n<<histogram>>\n@\n\\end{center}\n\\caption{Histogram of Age Ranges}\n\\label{fig:histogram}\n\\end{figure}\n\n\\section*{Strain Summaries}\n\n<<summary-statistics, echo=FALSE>>=\nrequire(plyr)\nrequire(reshape2)\nsummarised.data.all <- ddply(data, .(Driver,UAS,Genotype), summarise,\n                         Deaths = length(Age),\n                         Median.Age = median(Age),\n                         Age= mean(Age),\n                         Error = sd(Age, na.rm=T)/sqrt(length(Age)))\nsummarised.data.natural <- ddply(data[data$Accidental==FALSE,], .(Driver,UAS,Genotype), summarise,\n                         Deaths = length(Age),\n                         Median.Age = median(Age),\n                         Age= mean(Age),\n                         Error = sd(Age, na.rm=T)/sqrt(length(Age)))\nsummarised.data.natural.gene <- ddply(data[data$Accidental==FALSE,], .(Driver,Gene,Genotype), summarise,\n                         Deaths = length(Age),\n                         Median.Age = median(Age),\n                         Age= mean(Age),\n                         Error = sd(Age, na.rm=T)/sqrt(length(Age)))\n@\n\nThe total number of deaths for each cross and genotype is shown in Table \\ref{tab:total-deaths}.  Removing deaths that were accidental or not due to natural causes, the data is shown in Table \\ref{tab:analysed-deaths} and \\ref{tab:analysed-deaths_gene}.\n\n<<label=selected-data,echo=FALSE,results=tex>>=\nrequire(xtable)\nprint(xtable(dcast(summarised.data.all, Driver+UAS~Genotype, value.var='Deaths', margins=T, sum), caption = \"Total Natural Deaths for Each Cross and Genotype\", label = \"tab:total-deaths\"), include.rownames=F)\nprint(xtable(dcast(summarised.data.natural, Driver+UAS~Genotype, value.var='Deaths', margins=T, sum), caption = \"Total Natural Deaths for Each Cross and Genotype\", label = \"tab:analysed-deaths\"), include.rownames=F)\nprint(xtable(dcast(summarised.data.natural.gene, Driver+Gene~Genotype, value.var='Deaths', margins=T, sum), caption = \"Total Natural Deaths for Each Gene and Genotype\", label = \"tab:analysed-deaths_gene\"), include.rownames=F)\n@\n\n\\pagebreak\n\\section*{Survival Analysis}\n\nAll of these are relative to the reference Genotype which is the knockdown (GAL4/shRNA).\n\n\\subsection*{24B-Gal4 Driver}\nThis analysis is only for the three \\textit{Tsc1} shRNA alleles, since there were so few births in the \\textit{Raptor} knockdown alleles.  The summary statistics from this analysis are shown in Table \\ref{tab:coxph-summary-24b}.\n<<survival-analysis, echo=FALSE>>=\nrequire(survival)\nrequire(RColorBrewer)\ngenotype.colors <- brewer.pal(4, 'Set2')\nsummary.coxph.24b <- data.frame(row.names=levels(data$UAS)[1:3], \n                                n=rep(NA,3), \n                                logtest.p=rep(NA,3),\n                                waldtest.p=rep(NA,3),\n                                sctest.p=rep(NA,3))\nfor (uas in levels(data$UAS)[1:3]) {\n    data.used <- data[data$Driver=='24B-Gal4'&data$UAS==uas,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with 24B-GAL4 Driver', uas))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.24b[uas,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n                              logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n                              waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n                              sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.24b$padj <- p.adjust(summary.coxph.24b$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-24B-survival-plot.pdf', uas))\n    plot(survfit, main = sprintf('Survival of %s with 24B-GAL4 Driver', uas),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n        yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n\nsummary.coxph.24b.gene <- data.frame(row.names=levels(data$Gene), \n                                n=rep(NA,length(levels(data$Gene))), \n                                logtest.p=rep(NA,length(levels(data$Gene))),\n                                waldtest.p=rep(NA,length(levels(data$Gene))),\n                                sctest.p=rep(NA,length(levels(data$Gene))))\nfor (gene in levels(data$Gene)) {\n    data.used <- data[data$Driver=='24B-Gal4'&data$Gene==gene,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with 24B-GAL4 Driver', gene))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.24b.gene[gene,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n                              logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n                              waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n                              sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.24b$padj <- p.adjust(summary.coxph.24b$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-24B-survival-plot.pdf', gene))\n    plot(survfit, main = sprintf('Survival of %s with 24B-GAL4 Driver', gene),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n         yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n@\n\n\\subsection*{C179 Driver}\n\n<<c179-survival-analysis, echo=FALSE>>=\nsummary.coxph.c179 <- data.frame(row.names=levels(data$UAS)[c(4:6)], \n                                n=rep(NA,3), \n                                logtest.p=rep(NA,3),\n                                waldtest.p=rep(NA,3),\n                                sctest.p=rep(NA,3))\nfor (uas in levels(data$UAS)[c(4:6)]) {\n    data.used <- data[data$Driver=='C179-Gal4'&data$UAS==uas,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with C179-Gal4 Driver', uas))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.c179[uas,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n        logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n        waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n        sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.24b$padj <- p.adjust(summary.coxph.c179$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-C179-survival-plot.pdf', uas))\n    plot(survfit, main = sprintf('Survival of %s with C179-Gal4 Driver', uas),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n        yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n\nsummary.coxph.c179.gene <- data.frame(row.names=levels(data$Gene), \n                                n=rep(NA,length(levels(data$Gene))), \n                                logtest.p=rep(NA,length(levels(data$Gene))),\n                                waldtest.p=rep(NA,length(levels(data$Gene))),\n                                sctest.p=rep(NA,length(levels(data$Gene))))\nfor (gene in levels(data$Gene)[1]) {\n    data.used <- data[data$Driver=='C179-Gal4'&data$Gene==gene,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with C179-GAL4 Driver', gene))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.c179.gene[gene,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n                              logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n                              waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n                              sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.c179$padj <- p.adjust(summary.coxph.24b$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-C179-survival-plot.pdf', gene))\n    plot(survfit, main = sprintf('Survival of %s with C179-GAL4 Driver', gene),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n         yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n@\n\n\\subsection*{Hand-Gal4 Driver}\nThe summary statistics from this analysis are shown in Table \\ref{tab:coxph-summary-hand}.\n<<survival-analysis, echo=FALSE>>=\nsummary.coxph.hand <- data.frame(row.names=levels(data$UAS), n=rep(NA,6), \n                                logtest.p=rep(NA,6),\n                                waldtest.p=rep(NA,6),\n                                sctest.p=rep(NA,6)) \nfor (uas in levels(data$UAS)) {\n    data.used <- data[data$Driver=='Hand-Gal4'&data$UAS==uas,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with Hand-GAL4 Driver', uas))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.hand[uas,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n                               logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n                              waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n                              sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.hand$padj <- p.adjust(summary.coxph.hand$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-Hand-survival-plot.pdf', uas))\n    plot(survfit, main = sprintf('Survival of %s with Hand-GAL4 Driver', uas),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n         yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n\nsummary.coxph.hand.gene <- data.frame(row.names=levels(data$Gene), \n                                n=rep(NA,length(levels(data$Gene))), \n                                logtest.p=rep(NA,length(levels(data$Gene))),\n                                waldtest.p=rep(NA,length(levels(data$Gene))),\n                                sctest.p=rep(NA,length(levels(data$Gene))))\nfor (gene in levels(data$Gene)) {\n    data.used <- data[data$Driver=='Hand-Gal4'&data$Gene==gene,]\n    survobj <- with(data.used, Surv(Age, Accidental==FALSE))\n    survfit <- survfit(survobj~Genotype, data=data.used)\n    print(sprintf('Analysis of %s with Hand-GAL4 Driver', gene))\n    print(survfit(survobj~Genotype, data=data.used), print.rmean=TRUE)\n    print(coxph(survobj~Genotype, data=data.used))\n    summary.coxph.hand.gene[gene,] <- c(n=coxph(survobj~Genotype, data=data.used)$nevent,\n                              logtest.p=summary(coxph(survobj~Genotype, data=data.used))$logtest[3],\n                              waldtest.p=summary(coxph(survobj~Genotype, data=data.used))$wald[3],\n                              sctest.p=summary(coxph(survobj~Genotype, data=data.used))$sctest[3])\n    #summary.coxph.c179$padj <- p.adjust(summary.coxph.24b$logrank.p,n=3,method=\"BH\")\n    pdf(sprintf('figure/%s-Hand-survival-plot.pdf', gene))\n    plot(survfit, main = sprintf('Survival of %s with Hand-GAL4 Driver', gene),\n         xlab= 'Days',\n         ylab= 'Percent Survival',\n         yscale=100, \n         lty=c(1,2,2,2),\n         col= genotype.colors)\n    legend(\"bottomleft\", levels(data$Genotype), col=genotype.colors, lty=c(1,2,2,2), bty=\"n\")\n    dev.off()\n}\n@\n\n<<label=coxph-datatables,echo=FALSE,results=tex>>=\nlibrary(xtable)\nprint(xtable(summary.coxph.24b, digits=c(0,0,3,3,3),caption = \"Strain Level Cox Proportional Hazard Tests for 24B-Gal4 Drivers\", label = \"tab:coxph-summary-24b\"))\nprint(xtable(summary.coxph.c179, digits=c(0,0,3,3,3),caption = \"Strain Level Cox Proportional Hazard Tests for C179-Gal4 Drivers\", label = \"tab:coxph-summary-c79\"))\nprint(xtable(summary.coxph.hand, digits=c(0,0,3,3,3),caption = \"Strain Level Cox Proportional Hazard Tests for Hand-Gal4 Drivers\", label = \"tab:coxph-summary-hand\"))\nprint(xtable(summary.coxph.24b.gene, digits=c(0,0,3,3,3),caption = \"Gene Level Cox Proportional Hazard Tests for 24B-Gal4 Drivers\", label = \"tab:coxph-summary-24b-gene\"))\nprint(xtable(summary.coxph.c179.gene, digits=c(0,0,3,3,3),caption = \"Gene Level Cox Proportional Hazard Tests for C179-Gal4 Drivers\", label = \"tab:coxph-summary-c79-gene\"))\nprint(xtable(summary.coxph.hand.gene, digits=c(0,0,8,8,8),caption = \"Gene Level Cox Proportional Hazard Tests for Hand-Gal4 Drivers\", label = \"tab:coxph-summary-hand-gene\"))\n@\n\n\n<<bibliography, include=F, echo=F>>=\nrequire(bibtex)\nwrite.bib(c(names(sessionInfo()$otherPkgs),'base','stats','utils'), file='death-references.bib')\n@\n\nThe key packages used in this analysis were R \\cite{base}, lubridate \\cite{lubridate}, plyr \\cite{plyr} and survival \\cite{survival1, survival2}\n\n\\bibliography{death-references}\n\\bibliographystyle{unsrt}\n\n\\section*{Session Information}\n<<sessionInfo, results=tex, echo=F>>=\ntoLatex(sessionInfo())\n@\n\n\\end{document}",
    "created" : 1380810815109.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4062585834",
    "id" : "2B8953E",
    "lastKnownWriteTime" : 1380811102,
    "path" : "/Volumes/bridges_lab/Hatfield/Drosophila/Lifespan/longevity-analysis.Rnw",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "sweave"
}